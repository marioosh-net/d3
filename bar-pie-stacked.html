<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>d3</title>
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/d3.v3.min.js" charset="utf-8"></script>
    <style>
    body {
        font-size: 12px;
        font-family: sans-serif;
    }
    .arc path {
        stroke: #fff;
    }
    .bar {
        fill: steelblue;
    }
    .axis text {
        font: 10px sans-serif;
    }
    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }
    </style>
</head>

<body>

    <script>
    var data = [{
        train_id: 46311,
        dist_overall: 247,
        time_overall: 113322,
        time_ride: 33024,
        time_stop: 80297,
        time_overall_f: "07:28:42:000",
        time_ride_f: "09:10:24:000",
        time_stop_f: "22:18:17:000",
        perc_overall: 99.9991175588147,
        perc_ride: 29.141737703182084,
        perc_stop: 70.85737985563262,
        fuel_level: 3010,
        fuel_overall: 2449.0886488889405,
        fuel_overall_tt: null,
        fuel_ride: 2235.098674739405,
        fuel_stop: 213.98997414947758,
        avg_fuel_overall_dist: 9.915338659469395,
        avg_fuel_overall_time: 77.80236084785113,
        avg_fuel_ride_dist: 9.048982488823501,
        avg_fuel_ride_time: 243.65174506606886,
        avg_fuel_ride_brutto: 2.768966489848073,
        avg_fuel_stop_time: 9.593931366528254
    }, {
        train_id: 42311,
        dist_overall: 247,
        time_overall: 113322,
        time_ride: 33024,
        time_stop: 80297,
        time_overall_f: "07:28:42:000",
        time_ride_f: "09:10:24:000",
        time_stop_f: "22:18:17:000",
        perc_overall: 99.9991175588147,
        perc_ride: 29.141737703182084,
        perc_stop: 70.85737985563262,
        fuel_level: 3010,
        fuel_overall: 2449.0886488889405,
        fuel_overall_tt: null,
        fuel_ride: 2235.098674739405,
        fuel_stop: 213.98997414947758,
        avg_fuel_overall_dist: 9.915338659469395,
        avg_fuel_overall_time: 77.80236084785113,
        avg_fuel_ride_dist: 9.048982488823501,
        avg_fuel_ride_time: 243.65174506606886,
        avg_fuel_ride_brutto: 2.768966489848073,
        avg_fuel_stop_time: 9.593931366528254
    }, {
        train_id: 46312,
        dist_overall: 247,
        time_overall: 113322,
        time_ride: 13024,
        time_stop: 80297,
        time_overall_f: "07:28:42:000",
        time_ride_f: "09:10:24:000",
        time_stop_f: "22:18:17:000",
        perc_overall: 99.9991175588147,
        perc_ride: 29.141737703182084,
        perc_stop: 70.85737985563262,
        fuel_level: 3010,
        fuel_overall: 2449.0886488889405,
        fuel_overall_tt: null,
        fuel_ride: 2235.098674739405,
        fuel_stop: 213.98997414947758,
        avg_fuel_overall_dist: 9.915338659469395,
        avg_fuel_overall_time: 77.80236084785113,
        avg_fuel_ride_dist: 9.048982488823501,
        avg_fuel_ride_time: 243.65174506606886,
        avg_fuel_ride_brutto: 2.768966489848073,
        avg_fuel_stop_time: 9.593931366528254
    }, {
        train_id: 46313,
        dist_overall: 247,
        time_overall: 113322,
        time_ride: 29024,
        time_stop: 80297,
        time_overall_f: "07:28:42:000",
        time_ride_f: "09:10:24:000",
        time_stop_f: "22:18:17:000",
        perc_overall: 99.9991175588147,
        perc_ride: 29.141737703182084,
        perc_stop: 70.85737985563262,
        fuel_level: 3010,
        fuel_overall: 2449.0886488889405,
        fuel_overall_tt: null,
        fuel_ride: 2235.098674739405,
        fuel_stop: 213.98997414947758,
        avg_fuel_overall_dist: 9.915338659469395,
        avg_fuel_overall_time: 77.80236084785113,
        avg_fuel_ride_dist: 9.048982488823501,
        avg_fuel_ride_time: 243.65174506606886,
        avg_fuel_ride_brutto: 2.768966489848073,
        avg_fuel_stop_time: 9.593931366528254
    }];

    var bigNumberFormat = d3.format(".3s");

    /**
     * zwykly slupkowy
     *
     * params.col_data - kolumna brana do wykresow
     * params.col_name - kolumna brana jako tytul slupka
     * params.width - szerokosc wykresu
     * params.height - wysokosc wykresu
     * params.title - tytul wykresu
     */
    var bar = function(data, params) {

        data.forEach(function(el, i) {
            el[params.col_data] = +el[params.col_data];
        });

        /**
         * chart dimensions
         */
        var margin = {
                top: 20,
                right: 20,
                bottom: 20,
                left: 40
            },
            width = params.width - margin.left - margin.right,
            height = params.height - margin.top - margin.bottom;

        var x = d3.scale.ordinal()
            .rangeRoundBands([0, width], .1);

        var y = d3.scale.linear()
            .range([height, 0]);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .tickFormat(bigNumberFormat);

        var svg1 = d3.select("body").append("svg");
        var svg = svg1
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        x.domain(data.map(function(d) {
            return d[params.col_name];
        }));
        y.domain([0, d3.max(data, function(d) {
            return d[params.col_data];
        })]);

        svg.selectAll(".bar")
            .data(data)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function(d) {
                return x(d[params.col_name]);
            })
            .attr("width", x.rangeBand())
            .attr("y", function(d) {
                return y(d[params.col_data]);
            })
            .attr("height", function(d) {
                return height - y(d[params.col_data]);
            });

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text(params.col_data);

        /* tytul */
        svg1.append('text')
            .attr('x', '50%')
            .attr('y', '15')
            .attr('style', 'text-anchor: middle;')
            .text(params.title);

        /**
         * napisy na slupkach poziome
         */
        if(false) {
        var yTextPadding = 20;
        svg.selectAll(".bartext")
            .data(data)
            .enter()
            .append("text")
            .attr("class", "bartext")
            .attr("text-anchor", "middle")
            .attr("fill", "#fff")
            .attr("x", function(d, i) {
                return x(d[params.col_name]) + x.rangeBand() / 2;;
            })
            .attr("y", function(d, i) {
                return y(d[params.col_data]) + yTextPadding;
            })
            .text(function(d) {
                return d[params.col_name];
            });
          }

        /**
         * napisy na slupkach pionowe
         */
        var yTextPadding = 30;
        svg.selectAll(".bartext")
            .data(data)
            .enter()
            .append("text")
            .attr("transform", function(d) {
                return 'translate(' + (x(d[params.col_name]) + x.rangeBand() / 2) + ',' + (y(d[params.col_data]) + yTextPadding) + ') rotate(-90)';
            })
            .attr("class", "bartext")
            .attr("text-anchor", "middle")
            .attr("fill", "#fff")
            .attr("x", function(d, i) {
                return 0; //x(d[params.col_name])+x.rangeBand()/2;
            })
            .attr("y", function(d, i) {
                return 0; //y(d[params.col_data])+yTextPadding;
            })
            .text(function(d) {
                return d[params.col_name];
            });
    }

    /**
     * params.col_data - kolumny brane do wykresow
     * params.col_name - kolumna brana jako tytul fragmentu
     * params.width - szerokosc wykresu
     * params.height - wysokosc wykresu
     * params.title - tytul wykresu
     */
    var pie = function(data1, params) {

        var data = [];
        for (var key in data1[0]) {
            if (data1[0].hasOwnProperty(key)) {
                if (params.col_data.indexOf(key) != -1) {
                    var x = {};
                    x['age'] = key;
                    x['population'] = data1[0][key];
                    data.push(x);
                }
            }
        }
        console.log(data);

        var margin = {
                top: 10,
                right: 10,
                bottom: 10,
                left: 10
            },
            width = params.width - margin.left - margin.right,
            height = params.height - margin.top - margin.bottom,
            radius = Math.min(width, height) / 2;

        var color = d3.scale.category20c();

        var arc = d3.svg.arc()
            .outerRadius(radius - 10)
            .innerRadius(0);

        var pie = d3.layout.pie()
            .sort(null)
            .value(function(d) {
                return d.population;
            });

        var svg1 = d3.select("body").append("svg");
        var svg = svg1
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + ((width / 2) + margin.left) + "," + ((height / 2) + margin.bottom) + ")");

        data.forEach(function(d) {
            d.population = +d.population;
        });

        var g = svg.selectAll(".arc")
            .data(pie(data))
            .enter().append("g")
            .attr("class", "arc");

        g.append("path")
            .attr("d", arc)
            .style("fill", function(d) {
                return color(d.data.age);
            });

        g.append("text")
            .attr("transform", function(d) {
                return "translate(" + arc.centroid(d) + ")";
            })
            .attr("dy", ".35em")
            .style("text-anchor", "middle")
            .text(function(d) {
                return d.data.age;
            });

        /* tytul */
        svg1.append('text')
            .attr('x', '50%')
            .attr('y', '15')
            .attr('style', 'text-anchor: middle;')
            .text(params.title);

    }

    bar(data, {
        width: 300,
        height: 300,
        col_name: 'train_id',
        col_data: 'time_ride',
        title: 'średnie spalanie jazda [l/ktkm]'
    });

    pie(data, {
        width: 300,
        height: 300,
        col_name: 'train_id',
        col_data: ['time_ride', 'time_stop', 'time_overall'],
        title: 'średnie spalanie jazda [l/ktkm]'
    });
    </script>
</body>

</html>
