<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>d3</title>
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/d3.v3.min.js" charset="utf-8"></script>
    <style>
    body {
        font-size: 12px;
        font-family: sans-serif;
    }
    .arc path {
        stroke: #fff;
    }
    .arc text {
      fill: #fff;
    }
    .bar {
        fill: steelblue;
    }
    .bar text {
        fill: #fff;
    }
    .axis text {
        font: 10px sans-serif;
    }
    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }
    </style>
</head>

<body>

    <script>
    var data = [{
        train_id: 46311,
        dist_overall: 247,
        time_overall: 113322,
        time_ride: 33024,
        time_stop: 80297,
        time_overall_f: "07:28:42:000",
        time_ride_f: "09:10:24:000",
        time_stop_f: "22:18:17:000",
        perc_overall: 99.9991175588147,
        perc_ride: 29.141737703182084,
        perc_stop: 70.85737985563262,
        fuel_level: 3010,
        fuel_overall: 2449.0886488889405,
        fuel_overall_tt: null,
        fuel_ride: 2235.098674739405,
        fuel_stop: 213.98997414947758,
        avg_fuel_overall_dist: 9.915338659469395,
        avg_fuel_overall_time: 77.80236084785113,
        avg_fuel_ride_dist: 9.048982488823501,
        avg_fuel_ride_time: 243.65174506606886,
        avg_fuel_ride_brutto: 2.768966489848073,
        avg_fuel_stop_time: 9.593931366528254
    }, {
        train_id: 46414,
        dist_overall: 85,
        time_overall: 16802,
        time_ride: 11080,
        time_stop: 5721,
        time_overall_f: "04:40:02:000",
        time_ride_f: "03:04:40:000",
        time_stop_f: "01:35:21:000",
        perc_overall: 99.99404832758006,
        perc_ride: 65.94453041304607,
        perc_stop: 34.049517914533986,
        fuel_level: 910,
        fuel_overall: 699.764480000001,
        fuel_overall_tt: null,
        fuel_ride: 686.5557354992047,
        fuel_stop: 13.208744500795092,
        avg_fuel_overall_dist: 8.232523294117659,
        avg_fuel_overall_time: 149.93168241875986,
        avg_fuel_ride_dist: 8.077126299990644,
        avg_fuel_ride_time: 223.0686505232073,
        avg_fuel_ride_brutto: 2.2480173392682006,
        avg_fuel_stop_time: 8.311742737784012
    }, {
        train_id: 46444,
        dist_overall: 40,
        time_overall: 2417,
        time_ride: 2417,
        time_stop: null,
        time_overall_f: "00:40:17:000",
        time_ride_f: "00:40:17:000",
        time_stop_f: null,
        perc_overall: null,
        perc_ride: 100,
        perc_stop: null,
        fuel_level: 140,
        fuel_overall: 139.93767555555561,
        fuel_overall_tt: null,
        fuel_ride: 139.93767555555561,
        fuel_stop: null,
        avg_fuel_overall_dist: 3.49844188888889,
        avg_fuel_overall_time: 208.4301332230038,
        avg_fuel_ride_dist: 3.49844188888889,
        avg_fuel_ride_time: 208.4301332230038,
        avg_fuel_ride_brutto: 3.7296821843165144,
        avg_fuel_stop_time: null
    }, {
        train_id: 46462,
        dist_overall: 257,
        time_overall: 27828,
        time_ride: 23528,
        time_stop: 4299,
        time_overall_f: "07:43:48:000",
        time_ride_f: "06:32:08:000",
        time_stop_f: "01:11:39:000",
        perc_overall: 99.99640649705333,
        perc_ride: 84.54793732930861,
        perc_stop: 15.448469167744719,
        fuel_level: 2240,
        fuel_overall: 2099.5863466666656,
        fuel_overall_tt: null,
        fuel_ride: 2087.277891884084,
        fuel_stop: 12.308454782583295,
        avg_fuel_overall_dist: 8.16959667963683,
        avg_fuel_overall_time: 271.61531004743415,
        avg_fuel_ride_dist: 8.121703859471145,
        avg_fuel_ride_time: 319.372679819054,
        avg_fuel_ride_brutto: 2.4626148755218753,
        avg_fuel_stop_time: 10.307149852826207
    }, {
        train_id: 46471,
        dist_overall: 343,
        time_overall: 60644,
        time_ride: 34302,
        time_stop: 26341,
        time_overall_f: "16:50:44:000",
        time_ride_f: "09:31:42:000",
        time_stop_f: "07:19:01:000",
        perc_overall: 99.99835103225381,
        perc_ride: 56.56289162983972,
        perc_stop: 43.43545940241409,
        fuel_level: 1505,
        fuel_overall: 1503.5646711111187,
        fuel_overall_tt: null,
        fuel_ride: 1441.1869175579945,
        fuel_stop: 62.37775355312147,
        avg_fuel_overall_dist: 4.383570469711716,
        avg_fuel_overall_time: 89.25586729107624,
        avg_fuel_ride_dist: 4.201711129906689,
        avg_fuel_ride_time: 151.25278127248498,
        avg_fuel_ride_brutto: 4.479436172608412,
        avg_fuel_stop_time: 8.525109631040479
    }, {
        train_id: 46520,
        dist_overall: 39,
        time_overall: 4959,
        time_ride: 4319,
        time_stop: 640,
        time_overall_f: "01:22:39:000",
        time_ride_f: "01:11:59:000",
        time_stop_f: "00:10:40:000",
        perc_overall: 100,
        perc_ride: 87.09417221213954,
        perc_stop: 12.905827787860455,
        fuel_level: 175,
        fuel_overall: 174.9110444444443,
        fuel_overall_tt: null,
        fuel_ride: 173.3104870711299,
        fuel_stop: 1.6005573733144107,
        avg_fuel_overall_dist: 4.484898575498572,
        avg_fuel_overall_time: 126.97716475095774,
        avg_fuel_ride_dist: 4.443858642849484,
        avg_fuel_ride_time: 144.45884544016383,
        avg_fuel_ride_brutto: 1.2368100870719412,
        avg_fuel_stop_time: 9.00313522489356
    }, {
        train_id: 46615,
        dist_overall: 1,
        time_overall: 488,
        time_ride: null,
        time_stop: 174,
        time_overall_f: "00:08:08:000",
        time_ride_f: null,
        time_stop_f: "00:02:54:000",
        perc_overall: null,
        perc_ride: null,
        perc_stop: 35.65573770491803,
        fuel_level: 0,
        fuel_overall: 0.38670444444444396,
        fuel_overall_tt: null,
        fuel_ride: null,
        fuel_stop: 0.38670444444444396,
        avg_fuel_overall_dist: 0.38670444444444396,
        avg_fuel_overall_time: 2.852737704918029,
        avg_fuel_ride_dist: null,
        avg_fuel_ride_time: null,
        avg_fuel_ride_brutto: null,
        avg_fuel_stop_time: 8.000781609195393
    }, {
        train_id: 46312,
        dist_overall: 247,
        time_overall: 113322,
        time_ride: 33024,
        time_stop: 80297,
        time_overall_f: "07:28:42:000",
        time_ride_f: "09:10:24:000",
        time_stop_f: "22:18:17:000",
        perc_overall: 99.9991175588147,
        perc_ride: 29.141737703182084,
        perc_stop: 70.85737985563262,
        fuel_level: 3010,
        fuel_overall: 2449.0886488889405,
        fuel_overall_tt: null,
        fuel_ride: 2235.098674739405,
        fuel_stop: 213.98997414947758,
        avg_fuel_overall_dist: 9.915338659469395,
        avg_fuel_overall_time: 77.80236084785113,
        avg_fuel_ride_dist: 9.048982488823501,
        avg_fuel_ride_time: 243.65174506606886,
        avg_fuel_ride_brutto: 2.768966489848073,
        avg_fuel_stop_time: 9.593931366528254
    }];

    /**
     * mapa kolumn
     */
    var map = {
        train_id: 'train id',
        dist_overall: 'przejechany dystans w km',
        time_overall: 'czas przejazdu w sekundach',
        time_ride: 'czas jazdy w sekundach',
        time_stop: 'czas postoju w sekundach',
        time_overall_f: 'czas przejazdu sformatowany',
        time_ride_f: 'czas jazdy sformatowany',
        time_stop_f: 'czas postoju sformatowany',
        perc_ride: 'procent jazdy',
        perc_stop: 'procent postoju',
        fuel_overall: 'ilość zużytego paliwa ogółem w litrach',
        fuel_ride: 'ilość zużytego paliwa podczas jazdy w litrach',
        fuel_stop: 'ilość zużytego paliwa podczas postoju w litrach',
        avg_fuel_overall_dist: 'średnie spalanie całkowite [l/km]',
        avg_fuel_overall_time: 'średnie spalanie całkowite [l/h]',
        avg_fuel_ride_dist: 'średnie spalanie w czasie jazdy [l/km]',
        avg_fuel_ride_time: 'średnie spalanie w czasie jazdy [l/h]',
        avg_fuel_ride_brutto: 'średnie spalanie w czasie jazdy [l/ktkm]',
        avg_fuel_stop_time: 'średnie spalanie w czasie postoju [l/h]'
    }

    var bigNumberFormat = d3.format(".3s");

    /**
     * bar chart dla jednego parametru
     *
     * params.col_y - kolumna brana do wykresow (y)
     * params.col_x - kolumna brana jako tytul slupka (x)
     *
     * params.width - szerokosc wykresu
     * params.height - wysokosc wykresu
     * params.title - tytul wykresu
     */
    var bar = function(data, params) {

        data.forEach(function(el, i) {
            el[params.col_y] = +el[params.col_y];
        });

        /**
         * chart dimensions
         */
        var margin = {
                top: 20,
                right: 20,
                bottom: 20,
                left: 40
            },
            width = params.width - margin.left - margin.right,
            height = params.height - margin.top - margin.bottom;

        var x = d3.scale.ordinal()
            .rangeRoundBands([0, width], .1);

        var y = d3.scale.linear()
            .range([height, 0]);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .tickFormat(bigNumberFormat);

        var svg1 = d3.select("body").append("svg");
        var svg = svg1
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        x.domain(data.map(function(d) {
            return d[params.col_x];
        }));
        y.domain([0, d3.max(data, function(d) {
            return d[params.col_y];
        })]);

        svg.selectAll(".bar")
            .data(data)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function(d) {
                return x(d[params.col_x]);
            })
            .attr("width", x.rangeBand())
            .attr("y", function(d) {
                return y(d[params.col_y]);
            })
            .attr("height", function(d) {
                return height - y(d[params.col_y]);
            });

        /* bez osi x
        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);
        */

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis);/*
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text(params.col_y);*/

        /* tytul */
        svg1.append('text')
            .attr('x', '50%')
            .attr('y', '15')
            .attr('style', 'text-anchor: middle;')
            .text(/*params.title*/map[params.col_y]);

        /**
         * napisy na slupkach poziome
         */
        if (false) {
            var yTextPadding = 20;
            svg.selectAll(".bartext")
                .data(data)
                .enter()
                .append("text")
                .attr("class", "bartext")
                .attr("text-anchor", "middle")
                .attr("fill", "#fff")
                .attr("x", function(d, i) {
                    return x(d[params.col_x]) + x.rangeBand() / 2;;
                })
                .attr("y", function(d, i) {
                    return y(d[params.col_y]) + yTextPadding;
                })
                .text(function(d) {
                    return d[params.col_x];
                });
        }

        /**
         * napisy na slupkach pionowe
         */
        var yTextPadding = 30;
        svg.selectAll(".bartext")
            .data(data)
            .enter()
            .append("text")
            .attr("transform", function(d) {
                return 'translate(' + (x(d[params.col_x]) + x.rangeBand() / 2) + ',' + (y(d[params.col_y]) + yTextPadding) + ') rotate(-90)';
            })
            .attr("class", "bartext")
            .attr("text-anchor", "middle")
            .attr("fill", "#fff")
            .attr("x", function(d, i) {
                return 0; //x(d[params.col_x])+x.rangeBand()/2;
            })
            .attr("y", function(d, i) {
                return 0; //y(d[params.col_y])+yTextPadding;
            })
            .text(function(d) {
                return d[params.col_x];
            });
    }

    /**
     * pie chart dla jednej serii
     *
     * params.col_y - kolumny brane do wykresow
     *
     * params.width - szerokosc wykresu
     * params.height - wysokosc wykresu
     * params.title - tytul wykresu
     */
    var pie = function(data1, params) {

        /**
         * przeformatowanie danych
         */
        var data = [];
        for (var key in data1[0]) {
            if (data1[0].hasOwnProperty(key)) {
                if (params.col_y.indexOf(key) != -1) {
                    var x = {};
                    x['key'] = key;
                    x['val'] = data1[0][key];
                    data.push(x);
                }
            }
        }

        var margin = {
                top: 10,
                right: 10,
                bottom: 10,
                left: 10
            },
            width = params.width - margin.left - margin.right,
            height = params.height - margin.top - margin.bottom,
            radius = Math.min(width, height) / 2;

        var color = d3.scale.category20c();

        var arc = d3.svg.arc()
            .outerRadius(radius - 10)
            .innerRadius(0);

        var pie = d3.layout.pie()
            .sort(null)
            .value(function(d) {
                return d.val;
            });

        var svg1 = d3.select("body").append("svg");
        var svg = svg1
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + ((width / 2) + margin.left) + "," + ((height / 2) + margin.bottom) + ")");

        data.forEach(function(d) {
            d.val = +d.val;
        });

        var g = svg.selectAll(".arc")
            .data(pie(data))
            .enter().append("g")
            .attr("class", "arc");

        g.append("path")
            .attr("d", arc)
            .style("fill", function(d) {
                return color(d.data.key);
            });

        g.append("text")
            .attr("transform", function(d) {
                return "translate(" + arc.centroid(d) + ")";
            })
            .attr("dy", ".35em")
            .style("text-anchor", "middle")
            .text(function(d) {
                return d.data.key/*map[d.data.key]*/;
            });

        /* tytul */
        svg1.append('text')
            .attr('x', '50%')
            .attr('y', '15')
            .attr('style', 'text-anchor: middle;')
            .text(params.title);

    }

    /**
     * stacked bar chart dla wielu parametrow
     *
     * params.col_y - kolumny brane do wykresow (y)
     * params.col_x - kolumna brana jako tytul slupka (x)
     *
     * params.width - szerokosc wykresu
     * params.height - wysokosc wykresu
     * params.title - tytul wykresu
     */
    var stacked = function(data, params) {
        var margin = {
                top: 20,
                right: 20,
                bottom: 20,
                left: 40
            },
            width = params.width - margin.left - margin.right,
            height = params.height - margin.top - margin.bottom;

        var x = d3.scale.ordinal()
            .rangeRoundBands([0, width], .1);

        var y = d3.scale.linear()
            .rangeRound([height, 0]);

        var color = d3.scale.category20c();

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .tickFormat(d3.format(".2s"));

        var svg1 = d3.select("body").append("svg");
        var svg = svg1
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        color.domain(d3.keys(data[0]).filter(function(key) {
            return key !== params.col_x && params.col_y.indexOf(key) != -1 // tylko parametry z col_y
            ;
        }));

        data.forEach(function(d) {
            var y0 = 0;
            d.ages = color.domain().map(function(name) {
                return {
                    name: name,
                    y0: y0,
                    y1: y0 += +d[name]
                };
            });
            d.total = d.ages[d.ages.length - 1].y1;
        });

        data.sort(function(a, b) {
            return b.total - a.total;
        });

        x.domain(data.map(function(d) {
            return d[params.col_x];
        }));
        y.domain([0, d3.max(data, function(d) {
            return d.total;
        })]);

        /* bez osi x
        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);
        */

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Population");

        var state = svg.selectAll(".state")
            .data(data)
            .enter().append("g")
            .attr("class", "g")
            .attr("transform", function(d) {
                return "translate(" + x(d[params.col_x]) + ",0)";
            });

        state.selectAll("rect")
            .data(function(d) {
                return d.ages;
            })
            .enter().append("rect")
            .attr("width", x.rangeBand())
            .attr("y", function(d) {
                return y(d.y1);
            })
            .attr("height", function(d) {
                return y(d.y0) - y(d.y1);
            })
            .style("fill", function(d) {
                return color(d.name);
            });

        var legend = svg.selectAll(".legend")
            .data(color.domain().slice().reverse())
            .enter().append("g")
            .attr("class", "legend")
            .attr("transform", function(d, i) {
                return "translate(0," + i * 20 + ")";
            });

        legend.append("rect")
            .attr("x", width - 18)
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", color);

        legend.append("text")
            .attr("x", width - 24)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "end")
            .text(function(d) {
                return d;
            });

        /* tytul */
        svg1.append('text')
            .attr('x', '50%')
            .attr('y', '15')
            .attr('style', 'text-anchor: middle;')
            .text(params.title);
    }

    /**
     * histogram
     *
     * params.col_y - kolumna brane do wykresu
     *
     * params.width - szerokosc wykresu
     * params.height - wysokosc wykresu
     * params.title - tytul wykresu
     */
    var histogram = function(data, params) {

        var values = [];
        data.forEach(function(el, i) {
            values.push(+el[params.col_y]);
        });
        console.log(values);
        //var values = d3.range(1000).map(d3.random.bates(10));

        // A formatter for counts.
        var formatCount = d3.format(",.0f");

        var margin = {
                top: 20,
                right: 20,
                bottom: 20,
                left: 20
            },
            width = params.width - margin.left - margin.right,
            height = params.height - margin.top - margin.bottom;

        var x = d3.scale.linear()
            .domain([0, /*1*/ d3.max(values) /*100*/ ])
            .range([0, width]);

        // Generate a histogram using twenty uniformly-spaced bins.
        var data = d3.layout.histogram()
            .bins(x.ticks(10))
            (values);

        console.log(data);

        var y = d3.scale.linear()
            .domain([0, d3.max(data, function(d) {
                return d.y;
            })])
            .range([height, 0]);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var svg1 = d3.select("body").append("svg");
        var svg = svg1
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var bar = svg.selectAll(".bar")
            .data(data)
            .enter().append("g")
            .attr("class", "bar")
            .attr("transform", function(d) {
                return "translate(" + x(d.x) + "," + y(d.y) + ")";
            });

        bar.append("rect")
            .attr("x", 1)
            .attr("width", x(data[0].dx) - 1)
            .attr("height", function(d) {
                return height - y(d.y);
            });

        bar.append("text")
            .attr("dy", ".75em")
            .attr("y", 6)
            .attr("x", x(data[0].dx) / 2)
            .attr("text-anchor", "middle")
            .text(function(d) {
                return formatCount(d.y);
            });

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        /* tytul */
        svg1.append('text')
            .attr('x', '50%')
            .attr('y', '15')
            .attr('style', 'text-anchor: middle;')
            .text(/*params.title*/map[params.col_y]);

    }

    bar(data, {
        width: 300,
        height: 300,
        col_x: 'train_id',
        col_y: 'time_ride',
        title: 'średnie spalanie jazda [l/ktkm]'
    });

    pie(data, {
        width: 300,
        height: 300,
        col_y: ['time_ride', 'time_stop', 'time_overall'],
        title: 'średnie spalanie jazda [l/ktkm]'
    });

    stacked(data, {
        width: 300,
        height: 300,
        col_x: 'train_id',
        col_y: ['perc_ride', 'perc_stop'],
        title: 'średnie spalanie jazda [l/ktkm]'
    });

    histogram(data, {
        col_x: 'train_id',
        col_y: 'perc_ride',
        width: 300,
        height: 300,
        title: 'procent jazdy'
    });

    histogram(data, {
        col_x: 'train_id',
        col_y: 'perc_stop',
        width: 300,
        height: 300,
        title: 'procent postoju'
    });
    </script>
</body>

</html>
